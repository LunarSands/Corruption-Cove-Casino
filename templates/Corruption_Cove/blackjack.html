{% extends 'Corruption_Cove/base.html' %}
{% load static %}

{% block title_block %}
Blackjack
{% endblock %}

{% block body_block %}
<link rel="stylesheet" type="text/css" href= "{% static 'blackjack.css' %}">



<div id="grid">
    <div id="dealer">
        <img id="thumbnail" src="{{ dealer.face.url }}">
        <p class="welcome">{{dealer.name}}</p>
    </div>

<div id="dealer-hand">
    <img class="card" src="{% static 'images/cards/back.png' %}">
</div>

<div id="hand-0">
    <img class="card" src="{% static 'images/cards/back.png' %}">
    <img class="card" src="{% static 'images/cards/back.png' %}">
</div>

<div id="hand-1">

</div>
<div class='actions' id="actions-all">
{% for action in actions.all %}

<button onclick="do_action('{{action}}',0)">{{action}}</button> <br>

{% endfor %}
</div>
<div class='actions' id="actions-0">
{% for action in actions.0 %}

<button onclick="do_action('{{action}}',0)">{{action}} 0</button> <br>

{% endfor %}
</div>

<div class='actions' id="actions-1">
{% for action in actions.1 %}

<button onclick="do_action('{{action}}',1)">{{action}} 1</button> <br>

{% endfor %}
</div>
</div>

<p id="display"></p>

<script>
    fetch("{% url 'corruption-cove-casino:blackjack_api' %}")
        .then(data=>data.json())
        .then(data=>display_state(data));
    function display_hand(hand,id){
        document.getElementById(id).innerHTML = "";
        for(card of hand){
            document.getElementById(id).innerHTML += `<img class="card" src="{%static 'images/cards'%}/${card[0]+card[1]}.png"">`
        }
        return hand?.map(card=> card.join("")).join(",");
    }
    function display_state(state){
        console.log(state);
        hands = state.hands;
        dealer_hand = state.dealer_hand;
        bet = JSON.stringify(state.bets);
        document.getElementById('hand-0').innerHTML="";
        document.getElementById('hand-1').innerHTML="";
        for (let i = 0; i < hands.length; i++) {
            display_hand(hands[i],`hand-${i}`);
        }
        display_hand(dealer_hand,'dealer-hand');
    }
    function do_action(action,hand_no){
        console.log(action);
        fetch("{% url 'corruption-cove-casino:blackjack_api' %}",{method:'post',headers:{'X-CSRFToken':csrftoken},body:JSON.stringify(
            {action:action,hand_no:hand_no,bet:{amount:100}}
        )})
        .then(res=> res.json())
        .then(json=>display_state(json));
    }
    </script>
{% endblock %}