{% extends 'Corruption_Cove/base.html' %}
{% load static %}

{% block title_block %}
Roulette
{% endblock %}
    
{% block body_block %}
<link rel="stylesheet" type="text/css" href= "{% static 'roulette.css' %}">

    {% include 'Corruption_Cove/bets.html' %}

    <div class="roulette_images">
        <img class="base_roulette" src="{% static '/images/base_roulette.png' %}" alt="" width="384" height="384">
        <div class="wheel_roulette">
            <img src="{% static '/images/wheel_roulette.png' %}" alt="" width="384" height="384">
            <img class="ball_roulette" src="{% static '/images/ball_roulette.png' %}" alt="" width="384" height="384">
        </div>
    </div>

    <div class="controls">
        <div class="grid-container">
            {% for bet in bet_data %}
            <div onclick="addBetValue('{{bet.type}}')" class="{{bet.type}}">{{bet.name}}</div>
            {% endfor %}
        </div>
        <button onclick="checkBet()">Check Bets</button>
        <button onclick="clearBet()">Clear Bets</button>
        <button onclick="startBall()">Start Ball</button>
        <button data-href="{% url 'corruption-cove-casino:howToPlay' gameType='roulette' %}" onclick="window.open(this.dataset.href, 'how-to-play', 'width=600,height=400,toolbar=no,scrollbars=yes,resizable=yes'); return false;">
            How to play roulette?
        </button>
    </div>
    {{bet_data | json_script:"bet-data"}}
    <script>
        var moneyBet = 0;
        const currentBets = new Map();
        var request = {action:'start',bets:[]}
        const resultMap = new Map();
        const oddsBet = new Map();
        const betData = JSON.parse(document.getElementById('bet-data').textContent);
        const betTypes = betData.map(bet_data=>bet_data.type);
        const order = [0, 14, 31, 2, 33, 18, 27, 6, 21, 10, 19, 23, 4, 25, 12, 35, 16, 29, 8, 34, 13, 32, 9, 20, 17, 30, 1, 26, 5, 7, 22, 11, 36, 15, 28, 3, 24];
        const red = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];

        for (let i = 0; i < order.length; i++) {
            resultMap.set(i, order[i]);
        }

        for (let i = 0; i < betTypes.length; i++) {
            currentBets.set(betTypes[i], 0);
        }

        for (let i = 1; i < 37; i++){
            if (red.includes(i)){
                document.getElementsByClassName("bet-" + i)[0].style["background-color"] = "rgb(174, 13, 13)";
            }
            else {
                document.getElementsByClassName("bet-" + i)[0].style["background-color"] = "black";
            }
        }
        document.getElementsByClassName("bet-red")[0].style["background-color"] = "rgb(174, 13, 13)";
        document.getElementsByClassName("bet-black")[0].style["background-color"] = "black";

        function addBetValue(bet) {
            currentBets.set(bet, currentBets.get(bet)+100)
            moneyBet += 100;
        }

        function checkBet() {
            let outputText = "";
            for (let i = 0; i < betTypes.length; i++) {
                if (currentBets.get(betTypes[i]) != 0){
                    outputText = outputText.concat("You bet ", currentBets.get(betTypes[i]), " on ", betTypes[i], "\n");
                }
            }
            alert(outputText);
        }
        function clearBet() {
            for (let i = 0; i < betTypes.length; i++) {
                currentBets.set(betTypes[i], 0)
            }
            moneyBet = 0;
            request = {action:'start',bets:[]}
            alert('Bets Cleared');
        }

        function startBall(){
            for (const betType of currentBets.keys()) {
                request.bets.push({'type':betType,'amount':currentBets.get(betType)})
            }
            $.post({url:"{% url 'corruption-cove-casino:play_roulette' %}",
                data:JSON.stringify(request),
                headers:{'X-CSRFToken':csrftoken},
                success: function(output) {
                let message = "Your winnings: ";
                let result = output.result
                let winnings = output.winnings
                message = message.concat(winnings);
                message = message.concat("\nYour losses: -");
                message = message.concat(moneyBet);
                document.getElementsByClassName("ball_roulette")[0].style["display"] = "inline";
                document.getElementsByClassName("ball_roulette")[0].style["animation-iteration-count"] = order[result]/37 + 3;
                document.getElementsByClassName("ball_roulette")[0].style["animation-play-state"] = "running";
                setTimeout(function(){
                    document.getElementsByClassName("ball_roulette")[0].src = "{% static '/images/ball_roulette_alt.png' %}";
                    setTimeout(function() {
                        alert(message);
                        location.reload();
                    }, 1000)
                }, (order[result]/37 + 3) * 2000)
            }})
        }
    </script>
{% endblock %}