{% extends 'Corruption_Cove/base.html' %}
{% load static %}

{% block title_block %}
Slots - {{machine}}
{% endblock %}

{% block body_block %}
    <link rel="stylesheet" type="text/css" href= "{% static 'slots.css' %}">

    {% include 'Corruption_Cove/bets.html' %}
    <div class="all_wheels">
        <img class="wheel spinning" id="w1" src="{% static '/images/spinning_slots.gif' %}">
        <img class="wheel stopped" id="s1" src="{% static '/images/holdout.png' %}">
    </div>
    <div class="all_wheels">
        <img class="wheel spinning" id="w2" src="{% static '/images/spinning_slots.gif' %}">
        <img class="wheel stopped" id="s2" src="{% static '/images/holdout.png' %}">
    </div>
    <div class="all_wheels">
        <img class="wheel spinning" id="w3" src="{% static '/images/spinning_slots.gif' %}">
        <img class="wheel stopped" id="s3" src="{% static '/images/holdout.png' %}">
    </div>
    <button onclick="startWheels()">Spin!</button>
    <button data-href="{% url 'corruption-cove-casino:howToPlay' gameType='slots' %}" onclick="window.open(this.dataset.href, 'how-to-play', 'width=600,height=400,toolbar=no,scrollbars=yes,resizable=yes'); return false;">
        How to play slots?
    </button>
    <script>
        // on initialize: set default images on stationay wheels
        const WHEEL_OPACITY_TIME = 1500;
        const SPIN_TIME = 2000;
        const machine = "{{ machine|escapejs }}"
        var message = "You have won: "
        for (let i = 1; i<=3; i++){
            document.getElementById("s" + i).src = "/static/images/slots/" + machine + "/1.png";
        }

        function startWheels() {
            document.getElementById("w1").style["opacity"] = 100;
            document.getElementById("w2").style["opacity"] = 100;
            document.getElementById("w3").style["opacity"] = 100;
            // send request to server, get randomly generated results of the spin, set final images to them
            // at server level - update bets, update money account
            let request = {action:'start', machine:machine}
            $.post({url:"{% url 'corruption-cove-casino:slots_api' %}",
                data:JSON.stringify(request),
                headers:{'X-CSRFToken':csrftoken},
                success: function(output) {
                    let spinResultObjects = output.spin_result;
                    let spinResultAmount = output.spin_amount;
                    message = message.concat(spinResultAmount);
                    if (spinResultAmount == 1000){
                        message = message.concat(", JACKPOT!");
                    }
                    message = message.concat("\nYou have lost: -100");
                    let slotResultImgObjects = document.getElementsByClassName('wheel stopped');

                    for (let index=0; index<slotResultImgObjects.length; index++) {
                        const imgElement = slotResultImgObjects[index];
                        const resultElement = spinResultObjects[index];
                        imgElement.src = "/static/images/slots/" + machine + "/" + resultElement + ".png";
                    }

                    setTimeout(stopWheels, SPIN_TIME);
                }, error: function () {
                    alert("An error occured...");
                    setTimeout(stopWheels, 0);
                }
            });
        }

        function stopWheels() {
            setTimeout(function() {
                document.getElementById("w1").style["opacity"] = 0;
                setTimeout(function() {
                    document.getElementById("w2").style["opacity"] = 0;
                    setTimeout(function() {
                        document.getElementById("w3").style["opacity"] = 0;
                        setTimeout(function() {
                            alert(message);
                            location.reload();
                        }, WHEEL_OPACITY_TIME)
                    }, WHEEL_OPACITY_TIME)
                }, WHEEL_OPACITY_TIME)  
            }, WHEEL_OPACITY_TIME)
        }
    </script>
{% endblock %}